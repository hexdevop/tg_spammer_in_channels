# Телеграмм бот с поддержкой вебхуков, FastAPI и репликацией

Это шаблон для создания телеграмм бота с использованием библиотеки **aiogram** и поддержкой **FastAPI**. В проекте используется **PostgreSQL**, **Redis**, и **SQLAlchemy** с поддержкой репликации для хранения данных. Также включены миграции с **Alembic** для управления базой данных.

Проект поддерживает работу с **вебхуками**, что позволяет развертывать как бота, так и веб-приложение (или даже сайт) в одном приложении.

## Возможности

- **Telegram Bot**: Использование библиотеки `aiogram` для создания и управления телеграмм-ботом.
- **FastAPI**: Поддержка создания дополнительных страниц или целого веб-сайта с использованием FastAPI.
- **Вебхуки**: Возможность выбора вебхуков для телеграмм-бота и работы с ними.
- **Репликация PostgreSQL**: Использование **PostgreSQL** с репликацией для масштабируемости.
- **Redis**: Использование **Redis** для кэширования и быстрой работы с данными.
- **SQLAlchemy**: ORM для работы с базой данных и поддержка репликации.
- **Миграции Alembic**: Использование Alembic для управления схемой базы данных и миграциями.

## Установка

1. Клонируйте репозиторий:

   ```bash
   git clone https://github.com/hexdevop/template.git
   cd template
   ```

2. Создайте и активируйте виртуальное окружение:
   - Для Linux:
      ```bash
      python3 -m venv venv
      source venv/bin/activate
      ```
   - Для Windows:
     ```bash
     python -m venv venv
     venv\Scripts\activate
     ```

3. Установите зависимости:

   ```bash
   pip install -r requirements.txt
   ```

4. Настройте конфигурацию:
   - Заполните файл `.env` с вашими данными:
     - `bot.token` — токен вашего бота.
     - `bot.polling` — включить или выключить polling.
     - `bot.webhook` — настройки для вебхуков.
     - Данные для подключения к базе данных PostgreSQL и Redis.

5. Запустите миграции Alembic для настройки базы данных:

   ```bash
   alembic upgrade head
   ```

## Запуск

Для запуска бота с вебхуками и FastAPI, выполните команду:

```bash
python main.py
```

Если выбраны вебхуки в конфигурации, будет запущен сервер FastAPI и телеграмм-бот будет работать через вебхуки. В противном случае будет включен polling.

### Запуск в режиме вебхуков

- Для работы с вебхуками, вам нужно будет настроить внешний доступ (например, через `ngrok` или продакшн сервер).
- Если хотите использовать `ngrok` для тестирования локально, добавьте ваш **ngrok auth token** и настройте соответствующие параметры в `config.py`.

### Веб-сервер FastAPI

Если в конфигурации выбраны вебхуки, можно создавать дополнительные страницы или API с использованием FastAPI. Все это будет работать в одном приложении с ботом.

Пример маршрута для FastAPI:

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/status")
async def read_status():
    return {"status": "ok"}
```

Просто добавьте свои маршруты в файл `web/routes.py`.

## Структура проекта

- **bot/** — Основная логика бота, обработчики, middlewares, и другие утилиты.
- **config.py** — Конфигурация проекта.
- **database/** — Модели SQLAlchemy и настройки подключения к базе данных.
- **web/** — Логика FastAPI, страницы и API.
- **migrations/** — Миграции Alembic.
- **variables/** — Хранение переменных и настроек, доступных в боте.

## Миграции базы данных

Для работы с базой данных используется **SQLAlchemy** и **Alembic** для миграций. Чтобы создать новую миграцию, выполните команду:

```bash
alembic revision --autogenerate -m "description of changes"
```

Для применения миграций:

```bash
alembic upgrade head
```

## Используемые технологии

- **aiogram** — библиотека для создания телеграмм-ботов.
- **FastAPI** — фреймворк для создания API и веб-приложений.
- **PostgreSQL** — база данных с поддержкой репликации.
- **SQLAlchemy** — ORM для работы с базой данных.
- **Alembic** — инструмент для миграций базы данных.
- **Redis** — система кэширования.
- **ngrok** — инструмент для создания туннелей и тестирования вебхуков локально.

## Лицензия

Этот проект распространяется под лицензией MIT. См. файл `LICENSE` для подробностей.

